{{ if $.Site.Params.nightMode }}

<body class="io-black-mode">
    {{ else }}

    <body class="io-grey-mode">
        {{ end }}
        {{ if $.Site.Params.enablePreLoad }}
        <div id="loading">
            <style>
                .loader {
                    width: 250px;
                    height: 50px;
                    line-height: 50px;
                    text-align: center;
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-family: helvetica, arial, sans-serif;
                    font-weight: 900;
                    color: #f1404b;
                    letter-spacing: .2em
                }

                .loader::before,
                .loader::after {
                    content: "";
                    display: block;
                    width: 15px;
                    height: 15px;
                    background: #f1404b;
                    position: absolute;
                    animation: load .7s infinite alternate ease-in-out
                }

                .loader::before {
                    top: 0
                }

                .loader::after {
                    bottom: 0
                }

                @keyframes load {
                    0% {
                        left: 0;
                        height: 30px;
                        width: 15px
                    }

                    50% {
                        height: 8px;
                        width: 40px
                    }

                    100% {
                        left: 235px;
                        height: 30px;
                        width: 15px
                    }
                }
            </style>
            <div class="loader">{{ $.Site.Params.textPreLoad }}</div>
        </div>
        {{ end }}
        <div class="page-container">
            {{ if $.Site.Params.expandSidebar }}
            <div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width: 170px">
                {{ else }}
                <div id="sidebar" class="sticky sidebar-nav fade mini-sidebar" style="width: 60px;">
                    {{ end }}
                    <div class="modal-dialog h-100 sidebar-nav-inner">
                        <div class="sidebar-logo border-bottom border-color">
                            <div class="logo overflow-hidden">
                                <a href="/" class="logo-expanded">
                                    <img src="{{ absURL $.Site.Params.images.logoExpandLight }}" height="40"
                                        class="logo-light" alt="{{ .Site.Title }}">
                                    <img src="{{ absURL $.Site.Params.images.logoExpandDark }}" height="40"
                                        class="logo-dark d-none" alt="{{ .Site.Title }}">
                                </a>
                                <a href="/" class="logo-collapsed">
                                    <img src="{{ absURL $.Site.Params.images.logoCollapseLight }}" height="40"
                                        class="logo-light" alt="{{ .Site.Title }}">
                                    <img src="{{ absURL $.Site.Params.images.logoCollapseDark }}" height="40"
                                        class="logo-dark d-none" alt="{{ .Site.Title }}">
                                </a>
                            </div>
                        </div>
                        <div class="sidebar-menu flex-fill">
                            <div class="sidebar-scroll">
                                <div class="sidebar-menu-inner">
                                    <ul>
                                        {{/* Build sidebar from category/sub-category fields */}}
                                        {{ $allPages := where .Site.RegularPages "Section" "bookmarks" }}
                                        {{ $c1List := slice }}
                                        {{ range $allPages }}
                                        {{ if .Params.categories }}
                                        {{ $catName := "" }}
                                        {{ if eq (printf "%T" .Params.categories) "[]string" }}
                                        {{ $catName = index .Params.categories 0 }}
                                        {{ else }}
                                        {{ $catName = .Params.categories }}
                                        {{ end }}
                                        {{ $c1List = $c1List | append $catName }}
                                        {{ end }}
                                        {{ end }}
                                        {{ $c1List = $c1List | uniq }}

                                        {{/* Link generation logic depends on whether we are on the homepage or not */}}
                                        {{ $isHome := .IsHome }}

                                        {{ range $c1 := $c1List }}
                                        {{/* Filter pages by category array manually since where doesn't work perfectly
                                        with mixed string/array types */}}
                                        {{ $c1Pages := slice }}
                                        {{ range $allPages }}
                                        {{ $pageC1 := "" }}
                                        {{ if .Params.categories }}
                                        {{ if eq (printf "%T" .Params.categories) "[]string" }}
                                        {{ $pageC1 = index .Params.categories 0 }}
                                        {{ else }}
                                        {{ $pageC1 = .Params.categories }}
                                        {{ end }}
                                        {{ end }}
                                        {{ if eq $pageC1 $c1 }}
                                        {{ $c1Pages = $c1Pages | append . }}
                                        {{ end }}
                                        {{ end }}

                                        {{ $c2List := slice }}
                                        {{ range $c1Pages }}
                                        {{ if index .Params "sub-category" }}
                                        {{ $c2List = $c2List | append (index .Params "sub-category") }}
                                        {{ end }}
                                        {{ end }}
                                        {{ $c2List = $c2List | uniq }}

                                        <li class="sidebar-item has-sub">
                                            <a href="{{ if not $isHome }}/{{ end }}#{{ md5 $c1 }}"
                                                class="sidebar-link-toggle smooth">
                                                <i class="iconfont icon-classification fa-lg icon-fw icon-lg mr-2"></i>
                                                <span>{{ $c1 }}</span>
                                                {{ if $c2List }}
                                                <i class="iconfont icon-arrow-d-m sidebar-arrow"></i>
                                                {{ end }}
                                            </a>
                                            {{ if $c2List }}
                                            <ul class="sidebar-sub">
                                                <li><a href="/categories/{{ $c1 | urlize }}/"><span>üìå ÂÖ®ÈÉ®„Äå{{ $c1
                                                            }}„Äç</span></a></li>
                                                {{ range $c2 := $c2List }}
                                                {{/* Create an anchor hash that precisely matches the homepage blocks
                                                */}}
                                                {{ $hash := md5 (print $c1 "-" $c2) }}

                                                {{/* If on homepage, just href to hash. If not, href to /#hash */}}
                                                <li><a href="{{ if not $isHome }}/{{ end }}#term-{{
                                                        $hash }}" class="smooth"><span>{{ $c2 }}</span></a></li>
                                                {{ end }}
                                            </ul>
                                            {{ end }}
                                        </li>
                                        {{ end }}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="border-top py-2 border-color">
                            <div class="flex-bottom">
                                <ul>
                                    <li class="sidebar-item">
                                        <a target="_blank" rel="noopener" href="{{ $.Site.Params.about }}">
                                            <i class="fa fa-info-circle icon-fw icon-lg mr-2"></i>
                                            <span>ÂÖ≥‰∫éÊàë‰ª¨</span></a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        // Handle Sidebar Expand/Collapse Click
                        document.querySelectorAll('.sidebar-link-toggle').forEach(function (link) {
                            link.addEventListener('click', function (e) {
                                var parentLi = this.closest('.sidebar-item.has-sub');
                                if (parentLi && parentLi.querySelector('.sidebar-sub')) {
                                    // We keep default behavior to allow anchor hashing but also toggle menu visually
                                    parentLi.classList.toggle('open');
                                }
                            });
                        });

                        // Handle Smooth Anchor Scrolling for all .smooth links
                        document.querySelectorAll('a.smooth').forEach(function (anchor) {
                            anchor.addEventListener('click', function (e) {
                                // Only hijacking if linking to same page hash
                                if (this.getAttribute('href').startsWith('#')) {
                                    e.preventDefault();
                                    var targetId = this.getAttribute('href').substring(1);
                                    var targetElement = document.getElementById(targetId);
                                    if (targetElement) {
                                        // Provide smooth auto-scroll to the section
                                        targetElement.scrollIntoView({
                                            behavior: 'smooth',
                                            block: 'start'
                                        });
                                    }

                                    // Update URL without page jump
                                    if (history.pushState) {
                                        history.pushState(null, null, '#' + targetId);
                                    }
                                }
                            });
                        });
                    });
                </script>