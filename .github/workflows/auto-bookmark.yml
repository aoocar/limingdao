name: Auto Create Bookmark from Issue

on:
  issues:
    types: [opened]

jobs:
  create-bookmark:
    # ä»…å¤„ç†å¸¦æœ‰ "submit-website" æ ‡ç­¾çš„ Issue
    if: contains(github.event.issue.labels.*.name, 'submit-website')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Issue and Create Bookmark
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            const issueNumber = context.payload.issue.number;
            const issueUser = context.payload.issue.user.login;

            // --- è§£æ Issue è¡¨å•å­—æ®µ ---
            function parseField(body, fieldLabel) {
              // GitHub Issue forms render as: ### Label\n\nValue\n\n
              const regex = new RegExp(`### ${fieldLabel}\\s*\\n\\n([\\s\\S]*?)(?=\\n\\n###|$)`, 'i');
              const match = body.match(regex);
              if (match) {
                return match[1].trim();
              }
              return '';
            }

            const title = parseField(issueBody, 'ç½‘ç«™åç§°');
            const sitelink = parseField(issueBody, 'ç½‘ç«™é“¾æ¥');
            const description = parseField(issueBody, 'ç½‘ç«™ç®€ä»‹');
            let category = parseField(issueBody, 'ä¸€çº§åˆ†ç±»ï¼ˆé¢‘é“ï¼‰');
            const subCategory = parseField(issueBody, 'äºŒçº§åˆ†ç±»ï¼ˆå­ç±»ï¼‰') || 'é»˜è®¤';
            const logo = parseField(issueBody, 'Logo å›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰');
            const reason = parseField(issueBody, 'æ¨èç†ç”±ï¼ˆå¯é€‰ï¼‰');

            // --- å­—æ®µæ ¡éªŒ ---
            if (!title || !sitelink) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: 'âŒ **æäº¤å¤±è´¥**ï¼šç½‘ç«™åç§°å’Œé“¾æ¥ä¸ºå¿…å¡«é¡¹ï¼Œè¯·è¡¥å……åé‡æ–°æäº¤ã€‚'
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed',
                labels: ['submit-website', 'invalid']
              });
              return;
            }

            // å¤„ç† "å…¶ä»–" åˆ†ç±»çš„æƒ…å†µ
            if (category.includes('å…¶ä»–')) {
              category = 'æœªåˆ†ç±»';
            }

            // --- ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å ---
            const safeTitle = title
              .replace(/[<>:"/\\|?*\x00-\x1f]/g, '')  // ç§»é™¤éæ³•å­—ç¬¦
              .replace(/\s+/g, ' ')                      // åˆå¹¶ç©ºæ ¼
              .trim()
              .substring(0, 80);                         // é™åˆ¶é•¿åº¦

            const fileName = `content/bookmarks/${safeTitle}.md`;

            // --- ç”Ÿæˆ Markdown å†…å®¹ ---
            const logoLine = logo && logo !== '_No response_' ? `logo: "${logo}"` : '';
            const now = new Date().toISOString();

            let mdContent = `---
            title: "${title}"
            sitelink: "${sitelink}"
            description: "${description.substring(0, 200)}"
            categories: "${category}"
            sub-category: "${subCategory}"
            ${logoLine}
            weight: 10
            recommend: 0
            date: ${now}
            submitted_by: "${issueUser}"
            ---

            ${description}
            `.replace(/^            /gm, '').trim() + '\n';

            // --- åˆ›å»º PR åˆ†æ”¯ ---
            const branchName = `submit/issue-${issueNumber}-${safeTitle.substring(0, 30).replace(/\s/g, '-')}`;

            // è·å– main åˆ†æ”¯çš„æœ€æ–° SHA
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            // åˆ›å»ºæ–°åˆ†æ”¯
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: ref.object.sha
            });

            // åœ¨æ–°åˆ†æ”¯ä¸Šåˆ›å»ºæ–‡ä»¶
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: fileName,
              message: `ğŸ“ æ”¶å½•ç½‘ç«™: ${title} (from issue #${issueNumber})`,
              content: Buffer.from(mdContent).toString('base64'),
              branch: branchName
            });

            // --- åˆ›å»º Pull Request ---
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“ æ”¶å½•ç½‘ç«™: ${title}`,
              head: branchName,
              base: 'main',
              body: [
                `## ç”¨æˆ·æäº¤çš„ç½‘ç«™æ”¶å½•`,
                ``,
                `| å­—æ®µ | å†…å®¹ |`,
                `|---|---|`,
                `| **ç½‘ç«™åç§°** | ${title} |`,
                `| **é“¾æ¥** | ${sitelink} |`,
                `| **ç®€ä»‹** | ${description.substring(0, 100)} |`,
                `| **ä¸€çº§åˆ†ç±»** | ${category} |`,
                `| **äºŒçº§åˆ†ç±»** | ${subCategory} |`,
                `| **Logo** | ${logo || 'è‡ªåŠ¨æŠ“å–'} |`,
                `| **æäº¤äºº** | @${issueUser} |`,
                `| **æ¨èç†ç”±** | ${reason || 'æ— '} |`,
                ``,
                `> æ¥è‡ª Issue #${issueNumber}`,
                ``,
                `### ç”Ÿæˆçš„æ–‡ä»¶`,
                `\`${fileName}\``,
                ``,
                `---`,
                `âœ… åˆå¹¶æ­¤ PR å³å®Œæˆç½‘ç«™æ”¶å½•ï¼Œä¹¦ç­¾å°†åœ¨ä¸‹æ¬¡éƒ¨ç½²æ—¶è‡ªåŠ¨ä¸Šçº¿ã€‚`,
              ].join('\n')
            });

            // --- å›å¤ Issue å¹¶å…³é—­ ---
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `ğŸ‰ **æ„Ÿè°¢æäº¤ï¼** ä½ çš„ç½‘ç«™å·²è‡ªåŠ¨ç”Ÿæˆæ”¶å½•æ–‡ä»¶ã€‚`,
                ``,
                `ğŸ“‹ **å®¡æ ¸ PR**: ${pr.html_url}`,
                ``,
                `ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡å¹¶åˆå¹¶åï¼Œç½‘ç«™å°†è‡ªåŠ¨ä¸Šçº¿åˆ° [Limingdao é»æ˜å²›](https://limingdao.vercel.app/)ã€‚`
              ].join('\n')
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              labels: ['submit-website', 'pending-review']
            });

            console.log(`âœ… PR created: ${pr.html_url}`);
